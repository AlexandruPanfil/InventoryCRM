@page "/todo2"
@using InventoryCRM.Data
@using InventoryCRM.Models
@inject InventoryCRM.Services.TodoService TodoService
@rendermode InteractiveServer


@* <PageTitle>Todo Manager</PageTitle> *@
<h1>Todo Manager</h1>
<div class="mb-3">
    <div class="input-group">
        <input type="text" class="form-control" @bind="newTodoTitle"
               placeholder="Enter todo title..." @onkeyup="HandleKeyPress" />
        <button class="btn btn-primary" @onclick="AddTodo">
            <span class="bi bi-plus-circle"></span> Add Todo
        </button>
    </div>
</div>
@if (todos == null)
{
    <div class="text-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p><em>Loading todos...</em></p>
    </div>
}
else if (todos.Count == 0)
{
    <div class="alert alert-info">
        <span class="bi bi-info-circle"></span> No todos yet. Add your first todo above!
    </div>
}
else
{
    <div class="list-group">
        @foreach (var todo in todos)
        {
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           checked="@todo.IsCompleted"
                           @onchange="() => ToggleTodo(todo.Id)" />
                    <label class="form-check-label @(todo.IsCompleted ? "text-decoration-line-through text-muted" : "")">
                        @todo.Todo
                    </label>
                </div>
                <div>
                    <small class="text-muted me-3">@todo.Date.ToLocalTime().ToString("g")</small>
                    <button class="btn btn-danger btn-sm" @onclick="() => DeleteTodo(todo.Id)">
                        <span class="bi bi-trash"></span> Delete
                    </button>
                </div>
            </div>
        }
    </div>

    @* <div class="mt-3">
        <small class="text-muted">
            Total: @todos.Count todo(s) | 
            Completed: @todos.Count(t => t.IsCompleted) | 
            Pending: @todos.Count(t => !t.IsCompleted)
        </small>
    </div> *@
}
@code {
    private List<TodoItem>? todos;
    private string newTodoTitle = string.Empty;
    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }
    private async Task LoadTodos()
    {
        try
        {
            todos = await TodoService.GetAllTodosAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading todos: {ex.Message}");
            // In production, you'd show a user-friendly error message
            todos = new List<TodoItem>();
        }
    }
    private async Task AddTodo()
    {
        if (!string.IsNullOrWhiteSpace(newTodoTitle))
        {
            try
            {
                await TodoService.CreateTodoAsync(newTodoTitle);
                newTodoTitle = string.Empty;
                await LoadTodos();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error creating todo: {ex.Message}");
            }
        }
    }
    private async Task ToggleTodo(int id)
    {
        try
        {
            await TodoService.ToggleTodoAsync(id);
            await LoadTodos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error toggling todo: {ex.Message}");
        }
    }
    private async Task DeleteTodo(int id)
    {
        try
        {
            await TodoService.DeleteTodoAsync(id);
            await LoadTodos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting todo: {ex.Message}");
        }
    }
    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTodo();
        }
    }
}